---
lab:
    title: 'Azure Databricks でのデータの探索と変換'
    module: 'モジュール 3'
---

# ラボ 3 - Azure Databricks でのデータの探索と変換

このラボでは、さまざまな Apache Spark DataFrame メソッドを使用して、Azure Databricks でデータを探索して変換する方法を説明します。受講者は、標準的な DataFrame メソッドを実行してデータの探索と変換を行う方法を学びます。また、重複データの削除や、日時の値の操作、列の名前変更、データの集計など、より高度なタスクを実行する方法を学習します。

このラボを完了すると、次のことができるようになります。

- Azure Databricks で DataFrames を使用してデータの探索とフィルタリングを行う
- 今後のクエリをより早く実行できるように DataFrame をキャッシュする
- 重複データを削除する
- 日付/時刻の値を操作する
- DataFrame 列を削除して名前を変更する
- DataFrame に格納されているデータを集計する

## ラボの構成と前提条件

このラボを開始する前に、ラボ環境を作成するためのセットアップ手順が正常に完了していることを確認してください。さらに、ラボ 1 で作成した Azure Databricks クラスターが必要です。ラボ 1 を完了しなかった場合 (またはクラスターを削除した場合)、以下の手順には、ラボ 1 を作成する手順が含まれています。

## 演習 1 - DataFrame を使用する

この演習では、いくつかの Databricks ノートブックを使用して、DataFrame を操作するための基本的な概念と手法を学習します。

### タスク 1: Databricks アーカイブを複製する

1. 現在 Azure Databricks ワークスペースを開いていない場合は、Azure portal (<https://portal.azure.com>) で、デプロイ済みの Azure Databricks ワークスペースに移動し、「**ワークスペースの起動**」を選択します。
1. 左側のウインドウで、「**コンピューティング**」を選択します。既存のクラスターがある場合は、それが実行されていることを確認します (必要に応じて開始します)。既存のクラスターがない場合は、最新のランタイムと **Scala 2.12** 以降を使用する単一ノード クラスターを作成します。
1. クラスターの実行中に、左側のペインで「**ワークスペース**」 > 「**ユーザー**」を選択し、ユーザー名 (家のアイコンが付いたエントリ) を選択します。
1. 表示されたウィンドウで、ご自分の名前の横にある矢印を選択し、「**インポート**」を選択します。

    ![アーカイブをインポートするためのメニュー オプション](images/import-archive.png)

1. 「**ノートブックのインポート**」ダイアログ ボックスで URL を選択し、次の URL 内に貼り付けます。

    ```
    https://github.com/MicrosoftLearning/DP-203-Data-Engineer/raw/master/Allfiles/microsoft-learning-paths-databricks-notebooks/data-engineering/DBC/04-Working-With-Dataframes.dbc
    ```

1. 「**インポート**」を選択します。
1. 表示される **04-Working-With-Dataframes** フォルダーを選択します。

### タスク 2: *DataFrame の説明*ノートブックを実行する

1. **1.Describe-a-dataframe** ノートブックを開きます。
1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。ノートブック内で以下を行います。
  - DataFrame API の知識を深める
  - **SparkSession** クラスと **DataFrame** (別名 ***Dataset [Row]***) クラスの操作方法について説明します。
  - **カウント** アクションの使用方法について説明します。

### タスク 3: *DataFrame の使用*ノートブックを実行する

1. Azure Databricks ワークスペースの **04-Working-With-Dataframes** フォルダーで、**2.Use-common-dataframe-methods** ノートブックを開きます。
1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。ノートブック内で以下を行います。

    - DataFrame API の知識を深める
    - パフォーマンスに共通のデータフレーム メソッドを使用する
    - Spark API のドキュメントを探す

### タスク 4: *関数表示*ノートブックを実行する

1. Azure Databricks ワークスペースの **04-Working-With-Dataframes** フォルダーで、**3.Display-function** ノートブックを開きます。
1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。ノートブック内で以下を行います。

    - 次の変換の使用方法について説明します。
      - limit(..)
      - select(..)
      - drop(..)
      - distinct()`
      - dropDuplicates(..)
    - 次のアクションの使用方法について説明します。
      - show(..)
      - display(..)

### タスク 5: *特徴的な記事*の演習ノートブックを完了する

1. Azure Databricks ワークスペースの **04-Working-With-Dataframes** フォルダーで、**4.Exercise** ノートブックを開きます。**Distinct Articles** ノートブックを開きます。
1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。このノートブックでは、Parquet ファイルを読み取り、必要な変換を適用して、レコードの合計数を実行し、すべてのデータが正しく読み込まれたことを確認します。おまけとして、データを照合するスキーマを定義してみて、このスキーマを使用するように読み取り操作を更新できます。

    > 注: 対応するノートブックは **Solutions** サブフォルダー内にあります。これには、演習用に完成されたセルが含まれています。行き詰まった場合、または単に解決方法を確認したい場合は、このノートブックを参照してください。

## 演習 2 - DataFrame の高度なメソッドを使用する

この演習では、上記のラボで学んだ Azure Databricks DataFrames のコンセプトに基づき、データ エンジニアが DataFrame を使用してデータの読み取り、書き込み、変換で使用できる高度なメソッドをいくつか確認します。

### タスク 1: Databricks アーカイブを複製する

1. Databricks ワークスペースの左側のウィンドウで、「**ワークスペース**」を選択し、ホーム フォルダ－ (家のアイコンが付いた自分のユーザー名) に移動します。
1. 自分の名前の横の矢印を選択し、「**インポート**」を選択します。
1. 「**ノートブックのインポート**」ダイアログ ボックスで、「**URL**」を選択し、次の URL 内に貼り付けます。

    ```
    https://github.com/MicrosoftLearning/DP-203-Data-Engineer/raw/master/Allfiles/microsoft-learning-paths-databricks-notebooks/data-engineering/DBC/07-Dataframe-Advanced-Methods.dbc
    ```

1. 「**インポート**」を選択します。
1. 表示される **07-Dataframe-Advanced-Methods** フォルダーを選択します。

### タスク 2: *日付と時間の操作*ノートブックを実行する

1. Azure Databricks ワークスペースの **07-Dataframe-Advanced-Methods** フォルダーで、**1.DateTime-function** ノートブックを開きます。
1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。**sql.functions** 操作の詳細と日付と時刻の関数について説明します。

### タスク 3: *集計関数の使用*ノートブックを実行する

1. Azure Databricks ワークスペースの **07-Dataframe-Advanced-Methods** フォルダーで、**2.Use-Aggregate-Functions** ノートブックを開きます。

1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。ノートブック内では、さまざまな集計関数を学習します。

### タスク 4: *データの重複排除*の演習ノートブックを完了する

1. Azure Databricks ワークスペースの **07-Dataframe-Advanced-Methods** フォルダーで、**3.Exercise-Deduplication-of-Data** ノートブックを開きます。

1. 指示に従い、含まれているセルを実行する前に、クラスターをノートブックに接続します。この演習の目的は、DataFrames の使い方について学習したことを、列の名前変更などで実践することです。作業を行うための空のセルと共に、ノートブック内に手順が記載されています。ノートブックの下部には、作業が正確であることを検証するのに役立つ追加のセルがあります。

## 重要: クラスターをシャットダウンする

1. ラボが完了したら、左側のウィンドウ、「**コンピューティング**」を選択し、クラスターを選択します。次に、「**終了**」を選択してクラスターを停止します。
